<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>汉字多维筛选工具</title>
  <style>
    :root {
      --bg: #f5f5f7;
      --card-bg: #ffffff;
      --text: #1d1d1f;
      --text-secondary: #6e6e73;
      --border: #d2d2d7;
      --accent: #0071e3;
      --gold: #C9A96E;
      --wood: #4CAF50;
      --water: #2196F3;
      --fire: #e53935;
      --earth: #8D6E63;
      --radius: 10px;
      --shadow: 0 1px 3px rgba(0,0,0,0.08), 0 1px 2px rgba(0,0,0,0.06);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "PingFang SC",
        "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 24px 20px;
    }

    header {
      text-align: center;
      margin-bottom: 28px;
    }
    header h1 {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    header p {
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* ── Loading ── */
    .loading {
      text-align: center;
      padding: 80px 0;
      color: var(--text-secondary);
      font-size: 16px;
    }
    .loading .spinner {
      display: inline-block;
      width: 32px; height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-bottom: 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Filter Panel ── */
    .filter-panel {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 24px;
      margin-bottom: 20px;
    }

    .filter-row {
      display: flex;
      align-items: flex-start;
      margin-bottom: 16px;
      gap: 12px;
    }
    .filter-row:last-child { margin-bottom: 0; }

    .filter-label {
      flex-shrink: 0;
      width: 80px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      padding-top: 6px;
      text-align: right;
    }

    .filter-body { flex: 1; }

    /* ── Chips ── */
    .chips { display: flex; flex-wrap: wrap; gap: 8px; }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 5px 14px;
      border-radius: 20px;
      font-size: 14px;
      cursor: pointer;
      border: 1.5px solid var(--border);
      background: var(--card-bg);
      color: var(--text);
      transition: all 0.15s ease;
      user-select: none;
    }
    .chip:hover { border-color: #999; }
    .chip.active { color: #fff; border-color: transparent; }

    .chip[data-value="金"].active { background: var(--gold); }
    .chip[data-value="木"].active { background: var(--wood); }
    .chip[data-value="水"].active { background: var(--water); }
    .chip[data-value="火"].active { background: var(--fire); }
    .chip[data-value="土"].active { background: var(--earth); }

    .chip.struct-chip.active {
      background: var(--accent);
      border-color: var(--accent);
    }

    .chip.tone-chip.active {
      background: #ff6f00;
      border-color: #ff6f00;
    }

    /* ── Inputs ── */
    .range-inputs {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .range-inputs input[type="number"] {
      width: 72px;
      padding: 5px 10px;
      border: 1.5px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      text-align: center;
      outline: none;
      transition: border-color 0.15s;
    }
    .range-inputs input:focus { border-color: var(--accent); }
    .range-inputs span { color: var(--text-secondary); }

    .text-input {
      padding: 5px 12px;
      border: 1.5px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      width: 200px;
      outline: none;
      transition: border-color 0.15s;
    }
    .text-input:focus { border-color: var(--accent); }

    select.select-input {
      padding: 5px 12px;
      border: 1.5px solid var(--border);
      border-radius: 6px;
      font-size: 14px;
      min-width: 140px;
      outline: none;
      background: #fff;
      cursor: pointer;
      transition: border-color 0.15s;
    }
    select.select-input:focus { border-color: var(--accent); }

    /* ── Actions ── */
    .actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 10px;
    }

    .result-info {
      font-size: 15px;
      color: var(--text-secondary);
    }
    .result-info strong {
      color: var(--text);
      font-size: 22px;
      font-weight: 700;
    }

    .btn {
      padding: 7px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.15s;
    }
    .btn-reset {
      background: #f0f0f0;
      color: var(--text);
    }
    .btn-reset:hover { background: #e0e0e0; }

    /* ── Results ── */
    .results { /* container */ }

    .stroke-group {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 12px;
      overflow: hidden;
    }

    .stroke-header {
      padding: 12px 20px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      user-select: none;
      transition: background 0.1s;
    }
    .stroke-header:hover { background: #fafafa; }
    .stroke-header .arrow {
      display: inline-block;
      transition: transform 0.2s;
      font-size: 12px;
      color: var(--text-secondary);
    }
    .stroke-header.collapsed .arrow { transform: rotate(-90deg); }
    .stroke-header .count {
      color: var(--text-secondary);
      font-weight: 400;
      font-size: 13px;
    }

    .stroke-chars {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1px;
      background: #f0f0f2;
      border-top: 1px solid #f0f0f2;
    }
    .stroke-chars.hidden { display: none; }

    .char-card {
      background: var(--card-bg);
      padding: 10px 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      cursor: pointer;
      transition: background 0.1s;
      position: relative;
    }
    .char-card:hover { background: #f8f8fa; }

    .char-text {
      font-size: 28px;
      font-weight: 300;
      line-height: 1.2;
    }
    .char-pinyin {
      font-size: 12px;
      color: var(--text-secondary);
    }
    .char-meta {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 2px;
    }
    .tag {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 3px;
      line-height: 1.5;
    }
    .tag-wuxing {
      color: #fff;
      font-weight: 500;
    }
    .tag-wuxing-金 { background: var(--gold); }
    .tag-wuxing-木 { background: var(--wood); }
    .tag-wuxing-水 { background: var(--water); }
    .tag-wuxing-火 { background: var(--fire); }
    .tag-wuxing-土 { background: var(--earth); }
    .tag-radical {
      background: #e8eaf6;
      color: #3949ab;
    }
    .tag-struct {
      background: #f3e5f5;
      color: #7b1fa2;
    }

    .no-results {
      text-align: center;
      padding: 60px 0;
      color: var(--text-secondary);
      font-size: 15px;
    }

    /* ── Responsive ── */
    @media (max-width: 640px) {
      .filter-row {
        flex-direction: column;
        gap: 6px;
      }
      .filter-label {
        width: auto;
        text-align: left;
      }
      .stroke-chars {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
      .text-input { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>汉字多维筛选工具</h1>
      <p>数据来源：zidian.txcx.com · 支持五行、笔画、结构、部首、拼音多重组合筛选</p>
    </header>

    <div id="loading" class="loading">
      <div class="spinner"></div>
      <div>正在加载汉字数据...</div>
    </div>

    <div id="app" style="display:none;">
      <!-- Filter Panel -->
      <div class="filter-panel">
        <!-- 汉字搜索 -->
        <div class="filter-row">
          <div class="filter-label">汉字</div>
          <div class="filter-body">
            <input type="text" class="text-input" id="char-input"
                   placeholder="输入汉字，如 悦、冰" oninput="onFilterChange()">
          </div>
        </div>

        <!-- 五行 -->
        <div class="filter-row">
          <div class="filter-label">五行</div>
          <div class="filter-body">
            <div class="chips" id="wuxing-chips">
              <span class="chip" data-value="金" onclick="toggleChip(this)">金</span>
              <span class="chip" data-value="木" onclick="toggleChip(this)">木</span>
              <span class="chip" data-value="水" onclick="toggleChip(this)">水</span>
              <span class="chip" data-value="火" onclick="toggleChip(this)">火</span>
              <span class="chip" data-value="土" onclick="toggleChip(this)">土</span>
            </div>
          </div>
        </div>

        <!-- 笔画 -->
        <div class="filter-row">
          <div class="filter-label">笔画</div>
          <div class="filter-body">
            <div class="range-inputs">
              <input type="number" id="stroke-min" min="1" max="51" placeholder="最少" oninput="onFilterChange()">
              <span>～</span>
              <input type="number" id="stroke-max" min="1" max="51" placeholder="最多" oninput="onFilterChange()">
            </div>
          </div>
        </div>

        <!-- 结构 -->
        <div class="filter-row">
          <div class="filter-label">结构</div>
          <div class="filter-body">
            <div class="chips" id="struct-chips">
              <!-- 从数据动态生成 -->
            </div>
          </div>
        </div>

        <!-- 部首 -->
        <div class="filter-row">
          <div class="filter-label">部首</div>
          <div class="filter-body">
            <select class="select-input" id="radical-select" onchange="onFilterChange()">
              <option value="">不限</option>
            </select>
          </div>
        </div>

        <!-- 拼音 -->
        <div class="filter-row">
          <div class="filter-label">拼音</div>
          <div class="filter-body">
            <input type="text" class="text-input" id="pinyin-input"
                   placeholder="输入拼音，如 yi、yǐ" oninput="onFilterChange()">
          </div>
        </div>

        <!-- 声调 -->
        <div class="filter-row">
          <div class="filter-label">声调</div>
          <div class="filter-body">
            <div class="chips" id="tone-chips">
              <span class="chip tone-chip" data-value="1" onclick="toggleChip(this)">一声 (阴平)</span>
              <span class="chip tone-chip" data-value="2" onclick="toggleChip(this)">二声 (阳平)</span>
              <span class="chip tone-chip" data-value="3" onclick="toggleChip(this)">三声 (上声)</span>
              <span class="chip tone-chip" data-value="4" onclick="toggleChip(this)">四声 (去声)</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="actions">
        <div class="result-info">
          共找到 <strong id="result-count">0</strong> 个汉字
        </div>
        <button class="btn btn-reset" onclick="resetFilters()">重置筛选</button>
      </div>

      <!-- Results -->
      <div id="results"></div>
    </div>
  </div>

  <script>
    // ─────────────── Data & State ───────────────
    let allChars = [];
    let debounceTimer = null;

    // ─────────────── Tone Stripping & Detection ───────────────
    const TONE_MAP = {
      'ā':'a','á':'a','ǎ':'a','à':'a',
      'ē':'e','é':'e','ě':'e','è':'e',
      'ī':'i','í':'i','ǐ':'i','ì':'i',
      'ō':'o','ó':'o','ǒ':'o','ò':'o',
      'ū':'u','ú':'u','ǔ':'u','ù':'u',
      'ǖ':'v','ǘ':'v','ǚ':'v','ǜ':'v',
      'ü':'v',
    };
    // 声调符号 → 声调数字
    const TONE_NUM = {
      'ā':1,'á':2,'ǎ':3,'à':4,
      'ē':1,'é':2,'ě':3,'è':4,
      'ī':1,'í':2,'ǐ':3,'ì':4,
      'ō':1,'ó':2,'ǒ':3,'ò':4,
      'ū':1,'ú':2,'ǔ':3,'ù':4,
      'ǖ':1,'ǘ':2,'ǚ':3,'ǜ':4,
    };
    function stripTones(s) {
      return s.split('').map(c => TONE_MAP[c] || c).join('').toLowerCase();
    }
    function detectTone(pinyin) {
      for (const ch of pinyin) {
        if (TONE_NUM[ch]) return TONE_NUM[ch];
      }
      return 0; // 轻声或无声调
    }

    // ─────────────── Load Data ───────────────
    async function loadData() {
      try {
        const res = await fetch('data/characters.json');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        allChars = await res.json();
        // pre-compute stripped pinyin and tone for filtering
        allChars.forEach(c => {
          c._py = stripTones(c.pinyin);
          c._tone = detectTone(c.pinyin);
        });
        initFilters();
        applyFilters();
        document.getElementById('loading').style.display = 'none';
        document.getElementById('app').style.display = 'block';
      } catch (e) {
        document.getElementById('loading').innerHTML =
          `<div style="color:#e53935;">加载失败: ${e.message}<br>
           请确保已运行 <code>npm run crawl</code> 生成数据，<br>
           并通过 <code>npm run serve</code> 启动本地服务器。</div>`;
      }
    }

    // ─────────────── Init Filters ───────────────
    function initFilters() {
      // 结构 chips
      const structures = [...new Set(allChars.map(c => c.structure).filter(Boolean))];
      structures.sort();
      const structContainer = document.getElementById('struct-chips');
      structContainer.innerHTML = structures.map(s =>
        `<span class="chip struct-chip" data-value="${s}" onclick="toggleChip(this)">${s.replace('结构','')}</span>`
      ).join('');

      // 部首 dropdown
      const radicals = [...new Set(allChars.map(c => c.radical).filter(Boolean))];
      // 按笔画数排序(近似：按 unicode 排序即可)
      radicals.sort();
      const radicalSelect = document.getElementById('radical-select');
      radicals.forEach(r => {
        const opt = document.createElement('option');
        opt.value = r;
        opt.textContent = r;
        radicalSelect.appendChild(opt);
      });
    }

    // ─────────────── Filter Logic ───────────────
    function toggleChip(el) {
      el.classList.toggle('active');
      onFilterChange();
    }

    function onFilterChange() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(applyFilters, 120);
    }

    function getActiveChipValues(containerId) {
      return [...document.querySelectorAll(`#${containerId} .chip.active`)]
        .map(c => c.dataset.value);
    }

    function applyFilters() {
      const charSearch = document.getElementById('char-input').value.trim();
      const wuxing = getActiveChipValues('wuxing-chips');
      const structs = getActiveChipValues('struct-chips');
      const tones = getActiveChipValues('tone-chips').map(Number);
      const strokeMin = parseInt(document.getElementById('stroke-min').value) || 0;
      const strokeMax = parseInt(document.getElementById('stroke-max').value) || 999;
      const radical = document.getElementById('radical-select').value;
      const pinyinRaw = document.getElementById('pinyin-input').value.trim();
      const pinyin = stripTones(pinyinRaw);

      const filtered = allChars.filter(c => {
        if (charSearch && !charSearch.includes(c.char)) return false;
        if (wuxing.length > 0 && !wuxing.includes(c.wuxing)) return false;
        if (c.strokes < strokeMin || c.strokes > strokeMax) return false;
        if (structs.length > 0 && !structs.includes(c.structure)) return false;
        if (radical && c.radical !== radical) return false;
        if (pinyin && !c._py.startsWith(pinyin)) return false;
        if (tones.length > 0 && !tones.includes(c._tone)) return false;
        return true;
      });

      renderResults(filtered);
    }

    function resetFilters() {
      document.querySelectorAll('.chip.active').forEach(c => c.classList.remove('active'));
      document.getElementById('char-input').value = '';
      document.getElementById('stroke-min').value = '';
      document.getElementById('stroke-max').value = '';
      document.getElementById('radical-select').value = '';
      document.getElementById('pinyin-input').value = '';
      applyFilters();
    }

    // ─────────────── Render Results ───────────────
    function renderResults(chars) {
      document.getElementById('result-count').textContent = chars.length;

      if (chars.length === 0) {
        document.getElementById('results').innerHTML =
          '<div class="no-results">没有找到符合条件的汉字，请调整筛选条件</div>';
        return;
      }

      // Group by strokes
      const groups = {};
      chars.forEach(c => {
        if (!groups[c.strokes]) groups[c.strokes] = [];
        groups[c.strokes].push(c);
      });

      const strokeKeys = Object.keys(groups).map(Number).sort((a, b) => a - b);

      const html = strokeKeys.map(s => {
        const gChars = groups[s];
        return `
          <div class="stroke-group">
            <div class="stroke-header" onclick="toggleGroup(this)">
              <span class="arrow">▼</span>
              ${s}画
              <span class="count">(${gChars.length}个)</span>
            </div>
            <div class="stroke-chars">
              ${gChars.map(c => renderCharCard(c)).join('')}
            </div>
          </div>`;
      }).join('');

      document.getElementById('results').innerHTML = html;
    }

    function renderCharCard(c) {
      let meta = `<span class="tag tag-wuxing tag-wuxing-${c.wuxing}">${c.wuxing}</span>`;
      if (c.radical) meta += `<span class="tag tag-radical">${c.radical}</span>`;
      if (c.structure) meta += `<span class="tag tag-struct">${c.structure.replace('结构','')}</span>`;

      return `
        <div class="char-card" onclick="openDetail('${c.url || ''}')" title="${c.char} ${c.pinyin} ${c.wuxing} ${c.radical} ${c.structure}">
          <span class="char-text">${c.char}</span>
          <span class="char-pinyin">${c.pinyin}</span>
          <div class="char-meta">${meta}</div>
        </div>`;
    }

    function toggleGroup(header) {
      header.classList.toggle('collapsed');
      const chars = header.nextElementSibling;
      chars.classList.toggle('hidden');
    }

    function openDetail(url) {
      if (url) {
        window.open(url, '_blank');
      }
    }

    // ─────────────── Init ───────────────
    loadData();
  </script>
</body>
</html>
